<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyID Test - GreenMarket</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2ecc71;
        }

        .info {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .error {
            background: #ffebee;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            color: #c62828;
        }

        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }

        button:hover {
            background: #0052a3;
        }

        .config {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }

        label {
            font-weight: bold;
            display: block;
            margin-top: 15px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîê MyID Test Muhiti</h1>

        <div class="info">
            <strong>Eslatma:</strong> Bu test sahifasi MyID integratsiyasini tekshirish uchun.
        </div>

        <h2>Konfiguratsiya</h2>

        <label>Client ID:</label>
        <input type="text" id="clientId" value="quyosh_24_sdk-OYD9rRoHYRjJkpQ2LQNV0EG6KSXtKruUMkOCdY1v">

        <label>Redirect URI:</label>
        <input type="text" id="redirectUri" value="">

        <label>Scope:</label>
        <input type="text" id="scope" value="address,contacts,doc_data,common_data">

        <label>Base URL:</label>
        <select id="baseUrl">
            <option value="https://sso.egov.uz">Production: https://sso.egov.uz</option>
            <option value="https://sso-test.egov.uz">Test: https://sso-test.egov.uz</option>
        </select>

        <h2>Test</h2>
        <button onclick="testMyID()">MyID orqali kirish</button>
        <button onclick="showAuthUrl()">Auth URL ko'rish</button>
        <button onclick="checkCallback()">Callback tekshirish</button>

        <div id="result"></div>
    </div>

    <script>
        // Sahifa yuklanganda redirect URI ni avtomatik to'ldirish
        window.onload = function () {
            document.getElementById('redirectUri').value = window.location.origin + '/myid_callback.html';
        };

        function testMyID() {
            const clientId = document.getElementById('clientId').value;
            const redirectUri = document.getElementById('redirectUri').value;
            const scope = document.getElementById('scope').value;
            const baseUrl = document.getElementById('baseUrl').value;

            if (!clientId || !redirectUri) {
                showResult('Iltimos, barcha maydonlarni to\'ldiring!', 'error');
                return;
            }

            // State generatsiya qilish
            const state = Math.random().toString(36).substring(7);
            sessionStorage.setItem('myid_state', state);

            // Auth URL yaratish
            const authUrl = `${baseUrl}/sso/oauth/Authorization.do?` +
                `response_type=one_code&` +
                `client_id=${encodeURIComponent(clientId)}&` +
                `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                `scope=${encodeURIComponent(scope)}&` +
                `state=${state}`;

            console.log('Auth URL:', authUrl);

            // MyID ga yo'naltirish
            window.location.href = authUrl;
        }

        function showAuthUrl() {
            const clientId = document.getElementById('clientId').value;
            const redirectUri = document.getElementById('redirectUri').value;
            const scope = document.getElementById('scope').value;
            const baseUrl = document.getElementById('baseUrl').value;

            const state = 'test_state_123';

            const authUrl = `${baseUrl}/sso/oauth/Authorization.do?` +
                `response_type=one_code&` +
                `client_id=${encodeURIComponent(clientId)}&` +
                `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                `scope=${encodeURIComponent(scope)}&` +
                `state=${state}`;

            showResult(`
                <div class="config">
                    <strong>Auth URL:</strong><br>
                    <a href="${authUrl}" target="_blank">${authUrl}</a>
                </div>
            `, 'info');
        }

        function checkCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');

            if (error) {
                showResult(`Xato: ${error}`, 'error');
            } else if (code && state) {
                showResult(`
                    <strong>Callback muvaffaqiyatli!</strong><br>
                    Code: ${code}<br>
                    State: ${state}
                `, 'info');
            } else {
                showResult('Callback parametrlari topilmadi. MyID orqali kiring.', 'error');
            }
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = type;
            resultDiv.innerHTML = message;
        }
    </script>
</body>

</html>